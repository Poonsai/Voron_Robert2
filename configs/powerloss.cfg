#####################################################################
#   Power Loss Recovery
#   Resume prints after power loss
#####################################################################

# Enable powerloss recovery in printer.cfg:
# [powerloss_recovery]
# filename: ~/printer_data/config/powerloss.cfg
# save_gcode_state: SAVE_GCODE_STATE NAME=powerloss
# restore_gcode_state: RESTORE_GCODE_STATE NAME=powerloss

[gcode_macro RESUME_PRINT]
rename_existing: BASE_RESUME_PRINT
description: Enhanced resume with optional resume speed
gcode:
    {% set resume_speed = params.SPEED|default(100)|int %}
    {% set remesh = params.REMESH|default("false")|lower == "true" %}
    
    M118 Resuming print at {resume_speed}% speed...
    
    # Home if not homed (safety)
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    
    # Optional: Re-run bed mesh for accuracy after power loss
    {% if remesh %}
        M118 Re-running bed mesh for accuracy...
        BED_MESH_CALIBRATE RUNS=1
    {% endif %}
    
    # Run original resume
    BASE_RESUME_PRINT
    
    M118 Print resumed

[gcode_macro POWERLOSS_RECOVERY]
description: Check if recovering from power loss
gcode:
    {% set state = printer.powerloss_recovery %}
    
    {% if state %}
        M118 === Power Loss Recovery ===
        M118 File: {state.filename}
        M118 Position: {state.purged}
        M118 =============================
    {% else %}
        M118 No power loss recovery data
    {% endif %}

[gcode_macro ABORT_PRINT]
description: Cancel print and disable heaters
gcode:
    TURN_OFF_HEATERS
    M400
    M107
    G91
    G1 Z10
    G90
    G28 X Y
    M84
    M118 Print aborted
