#####################################################################
#   Print Statistics
#   Track and display print statistics
#####################################################################

[gcode_macro PRINT_STATS]
description: Display detailed print statistics
gcode:
    {% if printer.virtual_sdcard.print_stats %}
        {% set stats = printer.virtual_sdcard.print_stats %}
        
        M118 ========= PRINT STATS =========
        M118 Filename: {stats.filename}
        M118 State: {stats.state}
        
        # Calculate times
        {% set print_min = (stats.print_duration / 60)|int %}
        {% set total_min = (stats.total_duration / 60)|int %}
        
        M118 Print Time: {print_min} min ({ (print_min / 60)|round(2) } hr)
        M118 Total Time: {total_min} min ({ (total_min / 60)|round(2) } hr)
        
        # Progress
        {% set progress = (stats.progress * 100)|round(1) %}
        M118 Progress: {progress}%
        
        # Estimate remaining
        {% if stats.state == "printing" and progress > 0 %}
            {% set remaining = ((100 - progress) / progress * stats.print_duration / 60)|int %}
            M118 Est. Remaining: ~{remaining} min
        {% endif %}
        
        # Filament usage (if available)
        {% if stats.filament_used|default(0) > 0 %}
            {% set filament_mm = stats.filament_used %}
            {% set filament_m = (filament_mm / 1000)|round(2) %}
            M118 Filament Used: {filament_mm}mm ({filament_m}m)
        {% endif %}
        
        M118 ================================
        
        # Also display on screen
        { action_respond_info("Print: " + stats.filename + " | " + progress + "% | " + print_min + "min") }
    {% else %}
        M118 No print in progress
    {% endif %}

[gcode_macro JOB_STATUS]
description: Quick job status check
gcode:
    {% set state = printer.idle_timeout.state %}
    
    {% if state == "Printing" %}
        {% set stats = printer.virtual_sdcard.print_stats %}
        {% set progress = (stats.progress * 100)|round(1) %}
        {% set print_min = (stats.print_duration / 60)|int %}
        
        M117 Printing {progress}% | {print_min}min
    {% elif state == "Idle" %}
        M117 Ready
    {% else %}
        M117 {state}
    {% endif %}

[gcode_macro CLEAR_STATS]
description: Reset print statistics
gcode:
    {% if printer.virtual_sdcard.print_stats %}
        # This clears stats at end of print
        SDCARD_RESET_FILE
        M118 Print stats cleared
    {% endif %}
