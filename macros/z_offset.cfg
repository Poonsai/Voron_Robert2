#####################################################################
#   Z-Offset Memory
#   Save and load z-offset for different filaments
#####################################################################

# Save z-offset for current filament
# Uses SAVE_VARIABLE to store in config

[gcode_macro SAVE_Z_OFFSET]
description: Save current z-offset for a filament type
gcode:
    {% set material = params.MATERIAL|default("default")|string %}
    
    # Get current z-offset from probe
    {% set z_offset = printer.probe.z_offset|default(0) %}
    
    # Save to variable
    SAVE_VARIABLE VARIABLES={printer.save_variables.variables|combine({material ~ "_z_offset": z_offset})}
    
    M118 Saved z-offset for {material}: {z_offset}mm
    { action_respond_info(f"Z-offset saved: {material} = {z_offset}mm") }

[gcode_macro LOAD_Z_OFFSET]
description: Load saved z-offset for a filament type
gcode:
    {% set material = params.MATERIAL|default("default")|string %}
    {% set key = material ~ "_z_offset" %}
    {% set variables = printer.save_variables.variables %}
    
    {% if key in variables %}
        {% set z_offset = variables[key] %}
        # Apply offset (this requires manual adjustment or probe recalibration)
        M118 Z-offset for {material}: {z_offset}mm
        M118 Note: Run CALIBRATE_Z_OFFSET to apply this offset
    {% else %}
        M118 No saved z-offset found for {material}
    {% endif %}

[gcode_macro LIST_Z_OFFSETS]
description: List all saved z-offsets
gcode:
    {% set variables = printer.save_variables.variables %}
    
    M118 ===== Saved Z-Offsets =====
    {% set found = false %}
    {% for key, value in variables.items() %}
        {% if key.endswith("_z_offset") %}
            {% set material = key.replace("_z_offset", "") %}
            M118 {material}: {value}mm
            {% set found = true %}
        {% endif %}
    {% endfor %}
    
    {% if not found %}
        M118 No z-offsets saved
    {% endif %}
    M118 ============================

[gcode_macro QUICK_Z_OFFSET]
description: Quick adjust z-offset during print
gcode:
    {% set adjust = params.ADJUST|default(0)|float %}
    {% set current = printer.probe.z_offset|default(0) %}
    {% set new_offset = current + adjust %}
    
    # This is a visual adjustment only - true offset requires PROBE_CALIBRATE
    M118 Current z-offset: {current}mm
    M118 Adjustment: {adjust}mm
    M118 New offset: {new_offset}mm
    M118 Run SAVE_Z_OFFSET MATERIAL=<type> to save
