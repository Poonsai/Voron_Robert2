#####################################################################
#   Slicer Integration
#   Pre-print validation and setup macros
#####################################################################

[gcode_macro CHECK_SETUP]
description: Pre-print checklist
gcode:
    M118 ===== Pre-Print Checklist =====
    
    # Check homing
    {% set homed = printer.toolhead.homed_axes %}
    {% if homed == "xyz" %}
        M118 [OK] Axes homed: {homed}
    {% else %}
        M118 [WARN] Not homed: {homed}
    {% endif %}
    
    # Check temperatures
    {% set bed_target = printer.heater_bed.target|int %}
    {% set bed_temp = printer.heater_bed.temperature|int %}
    {% set hotend_target = printer.extruder.target|int %}
    {% set hotend_temp = printer.extruder.temperature|int %}
    
    M118 Bed:     {bed_temp}C / {bed_target}C (target)
    M118 Hotend:  {hotend_temp}C / {hotend_target}C (target)
    
    # Check filament
    {% set filament = printer.extruder.filament_detected if printer.extruder.filament_detected is defined else "unknown" %}
    M118 Filament detected: {filament}
    
    # Check bed mesh
    {% set mesh = printer.bed_mesh.mesh_ready %}
    M118 Bed mesh ready: {mesh}
    
    # Check SD card
    {% if printer.virtual_sdcard.is_active %}
        M118 SD Card: Active - {printer.virtual_sdcard.file_path}
    {% else %}
        M118 SD Card: Not active
    {% endif %}
    
    M118 ================================
    M118 Run CHECK_SETUP for this list

[gcode_macro VALIDATE_PRINT]
description: Validate printer is ready for print
gcode:
    {% set errors = [] %}
    
    # Check homing
    {% if "xyz" not in printer.toolhead.homed_axes %}
        {% set errors = errors + ["Not homed - run G28"] %}
    {% endif %}
    
    # Check bed temperature if target > 0
    {% if printer.heater_bed.target > 0 %}
        {% if printer.heater_bed.temperature < printer.heater_bed.target - 10 %}
            {% set errors = errors + ["Bed not at target temp"] %}
        {% endif %}
    {% endif %}
    
    # Check hotend temperature if target > 0
    {% if printer.extruder.target > 0 %}
        {% if printer.extruder.temperature < printer.extruder.target - 10 %}
            {% set errors = errors + ["Hotend not at target temp"] %}
        {% endif %}
    {% endif %}
    
    {% if errors %}
        M118 ===== Validation Errors =====
        {% for error in errors %}
            M118 [ERROR] {error}
        {% endfor %}
        M118 ================================
        { action_respond_info("Validation failed: " + errors|join(", ")) }
    {% else %}
        M118 [OK] Printer ready for print
    {% endif %}

[gcode_macro QUICK_START]
description: Quick print start - home, heat, validate
gcode:
    {% set bed = params.BED|default(60)|int %}
    {% set hotend = params.HOTEND|default(210)|int %}
    
    # Home all
    M118 Homing...
    G28
    
    # Heat
    M118 Heating... Bed:{bed}C Hotend:{hotend}C
    M140 S{bed}
    M104 S{hotend}
    M190 S{bed}
    M109 S{hotend}
    
    # Validate
    VALIDATE_PRINT
    
    M118 Ready to print!
