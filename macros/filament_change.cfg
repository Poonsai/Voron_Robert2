#####################################################################
#   Filament Change
#   Pause print, change filament, resume
#####################################################################

[gcode_macro CHANGE_FILAMENT]
description: Pause print and guide through filament change
gcode:
    {% set temp = params.TEMP|default(210)|int %}
    {% set unload_temp = params.UNLOAD_TEMP|default(180)|int %}
    {% set resume = params.RESUME|default("true")|lower == "true" %}
    
    {% if printer.idle_timeout.state == "Printing" %}
        SAVE_GCODE_STATE NAME=CHANGE_FILAMENT
        
        # Park and pause
        M118 Pausing print for filament change...
        PAUSE
        
        # Heat to unload temp
        M118 Heating to {unload_temp}C for unload...
        M104 S{unload_temp}
        M190 S{printer.heater_bed.target|int}
        
        # Unload filament
        M118 Unloading filament...
        M83
        G1 E-50 F1800
        G1 E-50 F1200
        
        # Wait for user to load new filament
        M118 Please load new filament, then send RESUME
        { action_respond_info(f"Filament change: Unload complete. Load new filament and run RESUME or M118 RESUME") }
        
        # Heat to print temp
        M118 Heating to {temp}C...
        M104 S{temp}
        M109 S{temp}
        
        # Prime new filament
        Ming new filament...
118 Prim        G1 E50 F600
        G1 E20 F300
        
        # Clean nozzle
        CLEAN_NOZZLE
        
        # Optionally resume
        {% if resume %}
            M118 Resuming print...
            RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT
            RESUME
        {% else %}
            M118 Filament ready. Run RESUME to continue print.
        {% endif %}
    {% else %}
        { action_respond_info("Not currently printing. Use LOAD_FILAMENT or UNLOAD_FILAMENT instead.") }
    {% endif %}

[gcode_macro RESUME_PRINT]
description: Resume from filament change (alias for RESUME)
gcode:
    RESUME
