#####################################################################
#   Utilities
#   WiFi status, power, emergency stop, timelapse
#####################################################################

[gcode_macro WIFI_STATUS]
description: Show WiFi connection status
gcode:
    {% if printer.executing }
        M118 === WiFi Status ===
        M118 Note: WiFi info requires moonraker API
    {% endif %}
    
    M117 WiFi: Use Mainsail/Fluidd for details

[gcode_macro PS_ON]
description: Turn on power supply (if relay configured)
gcode:
    # Requires PSU control hardware
    # Set pin to your PSU control pin
    # SET_PIN PIN=psu_pin VALUE=1
    M118 PSU control not configured

[gcode_macro PS_OFF]
description: Turn off power supply (if relay configured)
gcode:
    # Requires PSU control hardware
    M118 PSU control not configured

[gcode_macro EMERGENCY_STOP]
description: Complete emergency stop - everything off
gcode:
    M112
    # This triggers immediate emergency stop

[gcode_macro SOFT_STOP]
description: Gentle stop - save position then disable
gcode:
    # Save state if printing
    {% if printer.idle_timeout.state == "Printing" %}
        M400  # Wait for moves to complete
    {% endif %}
    
    # Turn off heaters
    TURN_OFF_HEATERS
    
    # Turn off fans
    M107
    
    # Disable steppers
    M84
    
    M118 Soft stop complete

[gcode_macro TIMELAPSE_TRIGGER]
description: Trigger timelapse frame
gcode:
    # For timelapse use with Moonraker/Crowsnest
    # This is a placeholder - configure in slicer
    {% set layer = params.LAYER|default(0)|int %}
    
    # The actual timelapse command depends on your setup
    # Common: _TIMELAPSE_TAKE_FRAME
    M118 Timelapse trigger (layer {layer})

[gcode_macro RESTART_KLIPPER]
description: Restart Klipper service
gcode:
    M118 Restarting Klipper...
    # Requires shell command or external trigger
    # sudo systemctl restart klipper

[gcode_macro RESTART_MOONRAKER]
description: Restart Moonraker service
gcode:
    M118 Restarting Moonraker...
    # Requires shell command

[gcode_macro SYSTEM_INFO]
description: Show system information
gcode:
    M118 === System Info ===
    M118 Klipper: Ready
    M118 Moonraker: {printer.moonraker.version|default("unknown")}
    M118 CPU Temp: {printer.mcu.temperature|default("N/A")}
    M118 ====================
